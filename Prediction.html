<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Analyze - Graha Role Mapping</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 14px;
            background-color: #ffffff;
            color: #333;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .nav-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            padding: 12px;
        }

        /* Input Section */
        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .input-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .input-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .positions-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
        }

        .positions-input:focus {
            outline: none;
            border-color: #1a237e;
        }

        .apply-btn {
            padding: 10px 16px;
            background: #1a237e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }

        .apply-btn:active {
            opacity: 0.8;
        }

        /* Chart Section */
        .chart-section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .rashi-chart {
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1px;
            padding: 1px;
            background-color: #1a237e;
            border-radius: 8px;
            overflow: hidden;
        }

        .rashi-box {
            background-color: white;
            padding: 3px;
            position: relative;
            min-height: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.6rem;
        }

        .rashi-number {
            display: none;
        }

        .planet-names {
            font-size: 0.6rem;
            text-align: center;
            color: #1a237e;
            word-wrap: break-word;
            line-height: 1.2;
            font-weight: 500;
        }

        .chart-title {
            grid-column: 2 / 4;
            grid-row: 2 / 4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.7rem;
            color: white;
            background-color: #1a237e;
            border-radius: 4px;
        }

        /* Table Styles */
        .table-section {
            margin-bottom: 16px;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            min-width: 700px;
        }

        th {
            background-color: #1a237e;
            color: white;
            font-weight: 600;
            padding: 10px 4px;
            text-align: center;
            text-transform: uppercase;
            font-size: 0.6rem;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:active {
            background-color: #e8eaf6;
        }

        /* Compound relationship colors */
        .compound-friend { background-color: #d4edda !important; color: #155724; }
        .compound-enemy { background-color: #f8d7da !important; color: #721c24; }
        .compound-neutral { background-color: #e2e3e5 !important; color: #383d41; }
        .compound-excellent { background-color: #c3e6cb !important; font-weight: bold; }
        .compound-bitter { background-color: #f5c6cb !important; font-weight: bold; }

        /* Select dropdown styling */
        select {
            padding: 5px 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.65rem;
            width: 100%;
            max-width: 70px;
            background-color: white;
            color: #333;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 4px center;
            padding-right: 16px;
        }

        select:focus {
            outline: none;
            border-color: #1a237e;
        }

        .karaka-select, .lord-select {
            max-width: 85px;
        }

        /* Floating Action Button */
        .fab-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .fab-button:active {
            transform: scale(0.95);
        }

        /* Context Window */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 1999;
            backdrop-filter: blur(2px);
        }

        .context-window {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 92%;
            max-width: 400px;
            max-height: 80vh;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            overflow: hidden;
            flex-direction: column;
        }

        .context-header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 16px;
        }

        .context-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .context-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .planet-info {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #1a237e;
        }

        .planet-info h3 {
            margin: 0 0 6px 0;
            font-size: 0.9rem;
            color: #1a237e;
        }

        .planet-info p {
            margin: 0;
            font-size: 0.8rem;
            color: #555;
            line-height: 1.5;
        }

        .context-footer {
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .context-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .context-btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: #1a237e;
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* Tablet and larger screens */
        @media screen and (min-width: 768px) {
            .main-content {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .input-section {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .input-label {
                margin-bottom: 0;
                white-space: nowrap;
            }

            .input-row {
                flex: 1;
                flex-wrap: nowrap;
            }

            .rashi-chart {
                max-width: 350px;
            }

            .rashi-box {
                padding: 6px;
                font-size: 0.75rem;
            }

            .planet-names {
                font-size: 0.75rem;
            }

            .chart-title {
                font-size: 0.9rem;
            }

            table {
                font-size: 0.8rem;
                min-width: auto;
            }

            th {
                padding: 12px 6px;
                font-size: 0.7rem;
            }

            td {
                padding: 10px 6px;
            }

            select {
                font-size: 0.75rem;
                max-width: 100px;
            }

            .karaka-select, .lord-select {
                max-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>Analyze</h1>
            <a href="index.html" class="nav-btn">Main</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Input Section -->
        <section class="input-section">
            <label class="input-label">Planet positions (Lg, Su, Ch, Ku, Bu, Gu, Sk, Sa, Ra, Ke):</label>
            <div class="input-row">
                <input id="positionsInput" type="text" class="positions-input" placeholder="e.g., 2,11,8,6,10,7,10,6,3,9">
                <button id="applyPositionsBtn" class="apply-btn">Apply</button>
            </div>
        </section>

        <!-- Rashi Chart -->
        <section class="chart-section">
            <div class="section-title">Rashi Chakra</div>
            <div class="rashi-chart">
                <div class="rashi-box"><span class="rashi-number">12</span><div class="planet-names" id="box12"></div></div>
                <div class="rashi-box"><span class="rashi-number">1</span><div class="planet-names" id="box1"></div></div>
                <div class="rashi-box"><span class="rashi-number">2</span><div class="planet-names" id="box2"></div></div>
                <div class="rashi-box"><span class="rashi-number">3</span><div class="planet-names" id="box3"></div></div>
                <div class="rashi-box"><span class="rashi-number">11</span><div class="planet-names" id="box11"></div></div>
                <div class="chart-title">Rashi<br>Chakra</div>
                <div class="rashi-box"><span class="rashi-number">4</span><div class="planet-names" id="box4"></div></div>
                <div class="rashi-box"><span class="rashi-number">10</span><div class="planet-names" id="box10"></div></div>
                <div class="rashi-box"><span class="rashi-number">5</span><div class="planet-names" id="box5"></div></div>
                <div class="rashi-box"><span class="rashi-number">9</span><div class="planet-names" id="box9"></div></div>
                <div class="rashi-box"><span class="rashi-number">8</span><div class="planet-names" id="box8"></div></div>
                <div class="rashi-box"><span class="rashi-number">7</span><div class="planet-names" id="box7"></div></div>
                <div class="rashi-box"><span class="rashi-number">6</span><div class="planet-names" id="box6"></div></div>
            </div>
        </section>

        <!-- Top Table -->
        <section class="table-section">
            <div class="section-title">Primary Analysis</div>
            <div class="table-container">
                <table id="topTable">
                    <tr>
                        <th>GRAHA</th>
                        <th>Rashi</th>
                        <th>ADHIPATHYA</th>
                        <th>STRENGTH</th>
                        <th style="display: none;">Rashi Number</th>
                        <th>STHAANA</th>
                        <th>SAMYOGA</th>
                        <th>DRUSTI</th>
                        <th>P.MAITRI</th>
                    </tr>
                </table>
            </div>
        </section>

        <!-- Bottom Table -->
        <section class="table-section">
            <div class="section-title">Planet Analysis</div>
            <div class="table-container">
                <table id="planetTable">
                    <tr>
                        <th>GRAHA</th>
                        <th>Rashi</th>
                        <th>ADHIPATHYA</th>
                        <th>STRENGTH</th>
                        <th style="display: none;">Rashi Number</th>
                        <th>STHAANA</th>
                        <th>SAMYOGA</th>
                        <th>DRUSTI</th>
                        <th>P.MAITRI</th>
                    </tr>
                </table>
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <button class="fab-button" onclick="showContextWindow()">Read</button>

    <!-- Context Window -->
    <div class="overlay" id="overlay" onclick="hideContextWindow()"></div>
    <div class="context-window" id="contextWindow" style="display: none;">
        <div class="context-header">
            <h2>Planet Details</h2>
        </div>
        <div class="context-body" id="planetDetails"></div>
        <div class="context-footer">
            <button class="context-btn btn-secondary" onclick="hideContextWindow()">Close</button>
            <button class="context-btn btn-primary" onclick="downloadPlanetDetails()">Print</button>
        </div>
    </div>

    <script>
        const planets = ['Lg', 'Su', 'Ch', 'Ku', 'Bu', 'Gu', 'Sk', 'Sa', 'Ra', 'Ke'];
        const rashis = ['Mesha', 'Vrushabha', 'Mithuna', 'Karka', 'Simha', 'Kanya', 'Tula', 'Vrushchika', 'Dhanu', 'Makara', 'Kumbha', 'Meena'];
        
        const rashiLords = {
            '1': 'Ku', '2': 'Sk', '3': 'Bu', '4': 'Ch', '5': 'Su', '6': 'Bu',
            '7': 'Sk', '8': 'Ku', '9': 'Gu', '10': 'Sa', '11': 'Sa', '12': 'Gu'
        };
        
        const lordshipData = {
            "1": { "Su": "5", "Ch": "4", "Ku": "1,8", "Bu": "3,6", "Gu": "9,12", "Sk": "2,7", "Sa": "10,11" },
            "2": { "Su": "4", "Ch": "3", "Ku": "7,12", "Bu": "2,5", "Gu": "8,11", "Sk": "1,6", "Sa": "9,10" },
            "3": { "Su": "3", "Ch": "2", "Ku": "6,11", "Bu": "1,4", "Gu": "7,10", "Sk": "5,12", "Sa": "8,9" },
            "4": { "Su": "2", "Ch": "1", "Ku": "5,10", "Bu": "3,12", "Gu": "6,9", "Sk": "4,11", "Sa": "7,8" },
            "5": { "Su": "1", "Ch": "12", "Ku": "4,9", "Bu": "2,11", "Gu": "5,8", "Sk": "3,10", "Sa": "6,7" },
            "6": { "Su": "12", "Ch": "11", "Ku": "3,8", "Bu": "1,10", "Gu": "4,7", "Sk": "2,9", "Sa": "5,6" },
            "7": { "Su": "11", "Ch": "10", "Ku": "2,7", "Bu": "9,12", "Gu": "3,6", "Sk": "1,8", "Sa": "4,5" },
            "8": { "Su": "10", "Ch": "9", "Ku": "1,6", "Bu": "8,11", "Gu": "2,5", "Sk": "7,12", "Sa": "3,4" },
            "9": { "Su": "9", "Ch": "8", "Ku": "5,12", "Bu": "7,10", "Gu": "1,4", "Sk": "6,11", "Sa": "2,3" },
            "10": { "Su": "8", "Ch": "7", "Ku": "4,11", "Bu": "6,9", "Gu": "3,12", "Sk": "5,10", "Sa": "1,2" },
            "11": { "Su": "7", "Ch": "6", "Ku": "3,10", "Bu": "5,8", "Gu": "2,11", "Sk": "4,9", "Sa": "12,1" },
            "12": { "Su": "6", "Ch": "5", "Ku": "2,9", "Bu": "4,7", "Gu": "1,10", "Sk": "3,8", "Sa": "11,12" }
        };

        const naturalRelationships = {
            'Su': { friends: ['Ch', 'Ku', 'Gu'], enemies: ['Sk', 'Sa'], neutral: ['Bu', 'Ra', 'Ke'] },
            'Ch': { friends: ['Su', 'Bu'], enemies: [], neutral: ['Gu', 'Ra', 'Ke', 'Sk', 'Sa', 'Ku'] },
            'Ku': { friends: ['Su', 'Ch', 'Gu'], enemies: ['Bu', 'Sk', 'Sa'], neutral: ['Ra', 'Ke'] },
            'Bu': { friends: ['Su', 'Sk'], enemies: ['Ch', 'Ku'], neutral: ['Gu', 'Sa', 'Ra', 'Ke'] },
            'Gu': { friends: ['Su', 'Ch', 'Ku'], enemies: ['Bu', 'Sk'], neutral: ['Sa', 'Ra', 'Ke'] },
            'Sk': { friends: ['Bu', 'Sa'], enemies: ['Su', 'Ch', 'Ku'], neutral: ['Gu', 'Ra', 'Ke'] },
            'Sa': { friends: ['Bu', 'Sk'], enemies: ['Su', 'Ch', 'Ku'], neutral: ['Gu', 'Ra', 'Ke'] },
            'Ra': { friends: ['Sa', 'Sk'], enemies: ['Su', 'Ch', 'Ku'], neutral: ['Bu', 'Gu', 'Ke'] },
            'Ke': { friends: ['Ku', 'Gu'], enemies: ['Su', 'Ch'], neutral: ['Bu', 'Sk', 'Sa', 'Ra'] }
        };

        function getLordship(planetName, lagnaRashi) {
            if (!lagnaRashi || planetName === 'Lg' || planetName === 'Ra' || planetName === 'Ke') return '';
            return lordshipData[lagnaRashi][planetName] || '';
        }

        const topTable = document.getElementById('topTable');
        const planetTable = document.getElementById('planetTable');

        function getPlanetSelectsOrdered() {
            return planets.map(p => document.querySelector(`select[data-planet="${p}"]`));
        }
        
        function calculateHouseNumber(planetRashiNumber, lagnaRashiNumber) {
            if (!planetRashiNumber || !lagnaRashiNumber) return '';
            if (planetRashiNumber === lagnaRashiNumber) return '1';
            
            let houseNumber = parseInt(planetRashiNumber) - parseInt(lagnaRashiNumber) + 1;
            if (houseNumber <= 0) houseNumber += 12;
            return houseNumber.toString();
        }

        function findConjunctions(planetIndex, rashiNumber, allSelects) {
            let conjunctions = [];
            allSelects.forEach((select, index) => {
                if (index !== planetIndex && select.value === rashiNumber && rashiNumber !== '' && planets[index] !== 'Lg') {
                    let planetName = planets[index];
                    if (planetName === 'Gu' || planetName === 'Sk') {
                        planetName += '(+)';
                    } else if (['Sa', 'Ku', 'Ra', 'Ke', 'Su'].includes(planetName)) {
                        planetName += '(-)';
                    } else if (planetName === 'Bu') {
                        let hasGuOrSk = false;
                        allSelects.forEach((innerSelect, innerIndex) => {
                            if (innerIndex !== index && innerSelect.value === rashiNumber) {
                                const innerPlanet = planets[innerIndex];
                                if (innerPlanet === 'Gu' || innerPlanet === 'Sk') {
                                    hasGuOrSk = true;
                                }
                            }
                        });
                        planetName += hasGuOrSk ? '(+)' : '(-)';
                    }
                    conjunctions.push(planetName);
                }
            });
            return conjunctions.join(', ');
        }

        function updateChart() {
            for(let i = 1; i <= 12; i++) {
                document.getElementById(`box${i}`).textContent = '';
            }
            
            const selects = getPlanetSelectsOrdered();
            const lagnaRashiNumber = selects[0] ? selects[0].value : '';
            
            selects.forEach((select, index) => {
                const rashiNumber = select.value;
                if(rashiNumber) {
                    const planetName = planets[index];
                    const box = document.getElementById(`box${rashiNumber}`);
                    box.textContent = box.textContent ? box.textContent + ', ' + planetName : planetName;

                    const row = select.parentNode.parentNode;

                    if (index === 0) {
                        if (row.cells[2]) row.cells[2].textContent = '';
                        if (row.cells[3]) row.cells[3].textContent = '';
                        if (row.cells[5]) row.cells[5].textContent = '';
                        if (row.cells[8]) { row.cells[8].textContent = ''; row.cells[8].className = ''; }

                        const conjunctionCell = row.cells[6];
                        conjunctionCell.textContent = findConjunctions(index, rashiNumber, selects);

                        const aspectCell = row.cells[7];
                        aspectCell.textContent = findAspects(index, rashiNumber, selects);
                    } else {
                        const strengthCell = row.cells[3];
                        const houseCell = row.cells[5];
                        const houseNumber = calculateHouseNumber(rashiNumber, lagnaRashiNumber);

                        let symbol = '';
                        if (['1', '4', '5', '7', '9', '10'].includes(houseNumber)) {
                            symbol = '(+)';
                        } else if (['6', '8', '12'].includes(houseNumber)) {
                            symbol = '(-)';
                        } else if (['2', '3', '11'].includes(houseNumber)) {
                            symbol = '(N)';
                        }

                        houseCell.textContent = houseNumber + symbol;

                        const planetStrength = determineStrength(planetName, parseInt(rashiNumber));
                        strengthCell.textContent = planetStrength;

                        const lordshipCell = row.cells[2];
                        lordshipCell.textContent = getLordship(planetName, lagnaRashiNumber);

                        const conjunctionCell = row.cells[6];
                        conjunctionCell.textContent = findConjunctions(index, rashiNumber, selects);

                        const aspectCell = row.cells[7];
                        aspectCell.textContent = findAspects(index, rashiNumber, selects);
                    }
                }
            });

            updateCompoundRelationships();
            if (typeof updateLordRow === 'function') updateLordRow();
            const k = document.getElementById('karakaSelect');
            const k2 = document.getElementById('karaka2Select');
            if (k && k.value && typeof copyPlanetToKaraka === 'function') copyPlanetToKaraka(k.value);
            if (k2 && k2.value && typeof copyPlanetToKaraka2 === 'function') copyPlanetToKaraka2(k2.value);
        }
        
        function calculateAspects(targetRashi, aspectingPlanet, aspectingRashi) {
            if (!targetRashi || !aspectingRashi) return false;
            
            const source = parseInt(aspectingRashi);
            const target = parseInt(targetRashi);
            
            const aspectingPlanetName = planets[aspectingPlanet];
            let aspects = [];
            
            if (aspectingPlanetName !== 'Lg') {
                let seventhHouse = source + 6;
                if (seventhHouse > 12) seventhHouse -= 12;
                if (target === seventhHouse) aspects.push("7th");
            }
            
            if (aspectingPlanetName === 'Gu') {
                let fifthHouse = source + 4;
                let ninthHouse = source + 8;
                
                if (fifthHouse > 12) fifthHouse -= 12;
                if (ninthHouse > 12) ninthHouse -= 12;
                
                if (target === fifthHouse) aspects.push("5th");
                if (target === ninthHouse) aspects.push("9th");
            }
            else if (aspectingPlanetName === 'Sa') {
                let thirdHouse = source + 2;
                let tenthHouse = source + 9;
                
                if (thirdHouse > 12) thirdHouse -= 12;
                if (tenthHouse > 12) tenthHouse -= 12;
                
                if (target === thirdHouse) aspects.push("3rd");
                if (target === tenthHouse) aspects.push("10th");
            }
            else if (aspectingPlanetName === 'Ku') {
                let fourthHouse = source + 3;
                let eighthHouse = source + 7;
                
                if (fourthHouse > 12) fourthHouse -= 12;
                if (eighthHouse > 12) eighthHouse -= 12;
                
                if (target === fourthHouse) aspects.push("4th");
                if (target === eighthHouse) aspects.push("8th");
            }
            
            return aspects.length > 0 ? aspects.join(",") : false;
        }

        function findAspects(planetIndex, rashiNumber, allSelects) {
            let aspects = [];
            allSelects.forEach((select, index) => {
                if (index !== planetIndex && select.value !== '') {
                    const aspectType = calculateAspects(rashiNumber, index, select.value);
                    if (aspectType && planets[index] !== 'Lg') {
                        let planetName = planets[index];
                        
                        if (planetName === 'Gu' || planetName === 'Sk') {
                            planetName += '(+)';
                        } else if (['Sa', 'Ku', 'Ra', 'Ke', 'Su'].includes(planetName)) {
                            planetName += '(-)';
                        } else if (planetName === 'Bu') {
                            let hasGuOrSkAspect = false;
                            allSelects.forEach((innerSelect, innerIndex) => {
                                if (innerIndex !== index && innerSelect.value !== '') {
                                    const innerAspect = calculateAspects(rashiNumber, innerIndex, innerSelect.value);
                                    if (innerAspect && (planets[innerIndex] === 'Gu' || planets[innerIndex] === 'Sk')) {
                                        hasGuOrSkAspect = true;
                                    }
                                }
                            });
                            planetName += hasGuOrSkAspect ? '(+)' : '(-)';
                        }
                        
                        aspects.push(planetName);
                    }
                }
            });
            return aspects.join(', ');
        }

        let planetStrengthData = null;
        async function loadPlanetStrengthData() {
            try {
                const resp = await fetch('planet_strength.json');
                if (!resp.ok) throw new Error('Network response was not ok');
                const data = await resp.json();
                planetStrengthData = {};
                data.forEach(item => { planetStrengthData[item.Planet] = item; });
            } catch (e) {
                const fallback = [
                    { "Planet": "Su", "Exaltation": 1, "Deblitation": 7, "Own_house1": 5, "Own_house2": 0 },
                    { "Planet": "Ch", "Exaltation": 2, "Deblitation": 8, "Own_house1": 4, "Own_house2": 0 },
                    { "Planet": "Ku", "Exaltation": 10, "Deblitation": 4, "Own_house1": 1, "Own_house2": 8 },
                    { "Planet": "Bu", "Exaltation": 6, "Deblitation": 12, "Own_house1": 3, "Own_house2": 6 },
                    { "Planet": "Gu", "Exaltation": 4, "Deblitation": 10, "Own_house1": 9, "Own_house2": 12 },
                    { "Planet": "Sk", "Exaltation": 12, "Deblitation": 6, "Own_house1": 2, "Own_house2": 7 },
                    { "Planet": "Sa", "Exaltation": 7, "Deblitation": 1, "Own_house1": 10, "Own_house2": 11 },
                    { "Planet": "Ra", "Exaltation": 3, "Deblitation": 9, "Own_house1": 0, "Own_house2": 0 },
                    { "Planet": "Ke", "Exaltation": 9, "Deblitation": 3, "Own_house1": 0, "Own_house2": 0 }
                ];
                planetStrengthData = {};
                fallback.forEach(item => { planetStrengthData[item.Planet] = item; });
            }
        }

        function determineStrength(planetCode, rashiNumber) {
            if (!planetStrengthData || !planetStrengthData[planetCode] || !rashiNumber) return '';
            const info = planetStrengthData[planetCode];
            const parts = [];
            if (info.Exaltation === rashiNumber) parts.push('Exaltation');
            if (info.Deblitation === rashiNumber) parts.push('Debilitation');
            if (info.Own_house1 === rashiNumber) parts.push('Own House1');
            if (info.Own_house2 === rashiNumber) parts.push('Own House2');
            return parts.join(', ');
        }

        function getHouseDistance(house1, house2) {
            if (!house1 || !house2) return 0;
            let distance = Math.abs(house2 - house1);
            if (distance > 6) {
                distance = 12 - distance;
            }
            return distance + 1;
        }

        function getTemporaryRelationship(house1, house2) {
            const friendlyHouses = [2, 3, 4, 10, 11, 12];
            const enemyHouses = [1, 5, 6, 7, 8, 9];
            const housePosition = getHouseDistance(house1, house2);
            
            if (friendlyHouses.includes(housePosition)) return 'friend';
            if (enemyHouses.includes(housePosition)) return 'enemy';
            return 'neutral';
        }

        function getNaturalRelationship(planet1, planet2) {
            if (planet1 === planet2) return 'neutral';
            if (!naturalRelationships[planet1]) return 'neutral';
            
            const rel1 = naturalRelationships[planet1];
            if (rel1.friends.includes(planet2)) return 'friend';
            if (rel1.enemies.includes(planet2)) return 'enemy';
            if (rel1.neutral.includes(planet2)) return 'neutral';
            return 'neutral';
        }

        function getFinalRelationship(naturalRel, tempRel) {
            const relationshipMatrix = {
                'friend': {
                    'friend': { text: 'Best Friend', class: 'compound-excellent' },
                    'neutral': { text: 'Friend', class: 'compound-friend' },
                    'enemy': { text: 'Neutral', class: 'compound-neutral' }
                },
                'neutral': {
                    'friend': { text: 'Friend', class: 'compound-friend' },
                    'neutral': { text: 'Neutral', class: 'compound-neutral' },
                    'enemy': { text: 'Enemy', class: 'compound-enemy' }
                },
                'enemy': {
                    'friend': { text: 'Neutral', class: 'compound-neutral' },
                    'neutral': { text: 'Enemy', class: 'compound-enemy' },
                    'enemy': { text: 'Bitter Enemy', class: 'compound-bitter' }
                }
            };
            
            return relationshipMatrix[naturalRel][tempRel];
        }

        function getRashiLordPosition(rashiLord, allSelects) {
            for (let i = 0; i < planets.length; i++) {
                if (planets[i] === rashiLord && allSelects[i].value) {
                    return parseInt(allSelects[i].value);
                }
            }
            return null;
        }

        function calculatePlanetRashiLordRelationship(planetIndex, allSelects) {
            const currentPlanet = planets[planetIndex];
            const currentHouse = allSelects[planetIndex].value;
            
            if (!currentHouse || currentPlanet === 'Lg') return null;
            
            const rashiLord = rashiLords[currentHouse];
            if (!rashiLord) return null;
            
            const rashiLordPosition = getRashiLordPosition(rashiLord, allSelects);
            if (!rashiLordPosition) return null;
            
            const naturalRel = getNaturalRelationship(currentPlanet, rashiLord);
            const tempRel = getTemporaryRelationship(parseInt(currentHouse), rashiLordPosition);
            const relationship = getFinalRelationship(naturalRel, tempRel);
            
            return {
                rashiLord: rashiLord,
                relationship: relationship.text,
                class: relationship.class
            };
        }

        function updateCompoundRelationships() {
            const selects = getPlanetSelectsOrdered();
            
            selects.forEach((select, index) => {
                const compoundCell = select.parentNode.parentNode.cells[8];
                if (planets[index] === 'Lg') {
                    compoundCell.innerHTML = '';
                    compoundCell.className = '';
                    return;
                }

                const strengthCell = select.parentNode.parentNode.cells[3];
                const strengthText = strengthCell.textContent;

                if (strengthText.includes('Own House1') || strengthText.includes('Own House2')) {
                    compoundCell.innerHTML = 'Own House';
                    compoundCell.className = '';
                } else {
                    const relationship = calculatePlanetRashiLordRelationship(index, selects);
                    if (relationship) {
                        compoundCell.innerHTML = `${relationship.rashiLord}: ${relationship.relationship}`;
                        compoundCell.className = relationship.class;
                    } else {
                        compoundCell.innerHTML = '';
                        compoundCell.className = '';
                    }
                }
            });
        }

        planets.forEach(planet => {
            const row = (planet === 'Lg') ? topTable.insertRow() : planetTable.insertRow();
            
            const planetCell = row.insertCell();
            planetCell.textContent = planet;
            
            const rashiCell = row.insertCell();
            const select = document.createElement('select');
            select.dataset.planet = planet;
            select.innerHTML = '<option value="">Select</option>' + 
                rashis.map((rashi, index) => `<option value="${index + 1}">${rashi}</option>`).join('');
            
            const lordshipCell = row.insertCell();
            
            const strengthCell = row.insertCell();
            
            const numberCell = row.insertCell();
            numberCell.style.display = 'none';
            
            const houseCell = row.insertCell();
            
            const conjunctionCell = row.insertCell();
            
            const aspectCell = row.insertCell();
            
            const compoundCell = row.insertCell();
            
            select.addEventListener('change', (e) => {
                numberCell.textContent = e.target.value;
                updateChart();
                if (typeof updateLordRow === 'function') updateLordRow();
                if (typeof copyPlanetToKaraka === 'function') {
                    const k = document.getElementById('karakaSelect');
                    const k2 = document.getElementById('karaka2Select');
                    if (k && k.value) copyPlanetToKaraka(k.value);
                    if (k2 && k2.value) copyPlanetToKaraka2(k2.value);
                }
            });
            
            rashiCell.appendChild(select);
        });

        (function createLordRow(){
            const rows = Array.from(topTable.rows);
            const lagnaIndex = rows.findIndex(r => r.cells && r.cells[0] && r.cells[0].textContent.trim() === 'Lg');
            const insertIndex = lagnaIndex >= 0 ? lagnaIndex + 1 : topTable.rows.length;
            const lordRow = topTable.insertRow(insertIndex);

            const nameCell = lordRow.insertCell();
            nameCell.textContent = 'Sthaana Bhala';

            const lordSelectCell = lordRow.insertCell();
            const lordSelect = document.createElement('select');
            lordSelect.className = 'lord-select';
            lordSelect.innerHTML = '<option value="">Select House</option>' +
                [2,3,4,5,6,7,8,9,10,11,12].map(n => `<option value="${n}">${n}th House</option>`).join('');
            lordSelectCell.appendChild(lordSelect);

            const lordAdhipathyaCell = lordRow.insertCell();
            const lordStrengthCell = lordRow.insertCell();
            const lordHiddenCell = lordRow.insertCell();
            lordHiddenCell.style.display = 'none';
            const lordHouseCell = lordRow.insertCell();
            const lordConjunctionCell = lordRow.insertCell();
            const lordAspectCell = lordRow.insertCell();
            const lordCompoundCell = lordRow.insertCell();

            function updateLordRow() {
                const selects = getPlanetSelectsOrdered();
                const lagnaSelect = selects[0];
                const lagnaRashi = lagnaSelect ? lagnaSelect.value : '';
                const selectedHouse = lordSelect.value;

                if (!lagnaRashi || !selectedHouse) {
                    lordAdhipathyaCell.textContent = '';
                    lordStrengthCell.textContent = '';
                    lordHiddenCell.textContent = '';
                    lordHouseCell.textContent = '';
                    lordConjunctionCell.textContent = '';
                    lordAspectCell.textContent = '';
                    lordCompoundCell.textContent = '';
                    return;
                }

                let target = parseInt(lagnaRashi, 10) + parseInt(selectedHouse, 10) - 1;
                if (target > 12) target -= 12;

                lordAdhipathyaCell.textContent = '';
                lordStrengthCell.textContent = '';
                lordHiddenCell.textContent = '';
                lordHouseCell.textContent = '';
                lordCompoundCell.textContent = '';
                lordCompoundCell.className = '';

                const occupants = [];
                selects.forEach((sel, idx) => {
                    if (sel && sel.value && parseInt(sel.value,10) === target && planets[idx] !== 'Lg') {
                        occupants.push(planets[idx]);
                    }
                });
                lordConjunctionCell.textContent = occupants.join(', ');

                const aspectors = [];
                selects.forEach((sel, idx) => {
                    if (idx === 0) return;
                    if (!sel.value) return;
                    const aspectType = calculateAspects(String(target), idx, sel.value);
                    if (aspectType) {
                        let pname = planets[idx];
                        if (pname === 'Gu' || pname === 'Sk') pname += '(+)';
                        else if (['Sa','Ku','Ra','Ke','Su'].includes(pname)) pname += '(-)';
                        else if (pname === 'Bu') {
                            let hasGuOrSk = false;
                            selects.forEach((innerSel, innerIdx) => {
                                if (innerIdx !== idx && innerSel.value) {
                                    const innerAspect = calculateAspects(String(target), innerIdx, innerSel.value);
                                    if (innerAspect && (planets[innerIdx] === 'Gu' || planets[innerIdx] === 'Sk')) hasGuOrSk = true;
                                }
                            });
                            pname += hasGuOrSk ? '(+)' : '(-)';
                        }
                        aspectors.push(pname);
                    }
                });
                lordAspectCell.textContent = aspectors.join(', ');
            }

            lordSelect.addEventListener('change', updateLordRow);
            document.addEventListener('DOMContentLoaded', () => updateLordRow());
            updateLordRow();
            window.updateLordRow = updateLordRow;
        })();

        (function createKarakaRows(){
            const rows = Array.from(topTable.rows);
            const lagnaIndex = rows.findIndex(r => r.cells && r.cells[0] && r.cells[0].textContent.trim() === 'Lg');
            const lordIndex = rows.findIndex(r => r.cells && r.cells[0] && r.cells[0].textContent.trim() === 'Sthaana Bhala');
            const baseIndex = (lordIndex >= 0) ? lordIndex + 1 : (lagnaIndex >= 0 ? lagnaIndex + 1 : topTable.rows.length);

            const karakaRow = topTable.insertRow(baseIndex);
            karakaRow.insertCell().textContent = 'Karaka Bhala';
            const karakaRashiCell = karakaRow.insertCell();
            const karakaSelect = document.createElement('select');
            karakaSelect.className = 'karaka-select';
            karakaSelect.id = 'karakaSelect';
            karakaSelect.innerHTML = '<option value="">Select Planet</option>' + planets.map(p=>`<option value="${p}">${p}</option>`).join('');
            karakaRashiCell.appendChild(karakaSelect);
            const karakaRashiSpan = document.createElement('span');
            karakaRashiSpan.style.marginLeft = '8px';
            karakaRashiSpan.style.fontSize = '0.7rem';
            karakaRashiCell.appendChild(karakaRashiSpan);
            const karakaAdhipathya = karakaRow.insertCell();
            const karakaStrength = karakaRow.insertCell();
            const karakaHidden = karakaRow.insertCell(); karakaHidden.style.display='none';
            const karakaHouse = karakaRow.insertCell();
            const karakaSamyoga = karakaRow.insertCell();
            const karakaDrusti = karakaRow.insertCell();
            const karakaPm = karakaRow.insertCell();

            const karaka2Row = topTable.insertRow(baseIndex + 1);
            karaka2Row.insertCell().textContent = 'Adhipatya Bhala';
            const karaka2RashiCell = karaka2Row.insertCell();
            const karaka2Select = document.createElement('select');
            karaka2Select.className = 'karaka-select';
            karaka2Select.id = 'karaka2Select';
            karaka2Select.innerHTML = '<option value="">Select Planet</option>' + planets.map(p=>`<option value="${p}">${p}</option>`).join('');
            karaka2RashiCell.appendChild(karaka2Select);
            const karaka2RashiSpan = document.createElement('span');
            karaka2RashiSpan.style.marginLeft = '8px';
            karaka2RashiSpan.style.fontSize = '0.7rem';
            karaka2RashiCell.appendChild(karaka2RashiSpan);
            const karaka2Adhipathya = karaka2Row.insertCell();
            const karaka2Strength = karaka2Row.insertCell();
            const karaka2Hidden = karaka2Row.insertCell(); karaka2Hidden.style.display='none';
            const karaka2House = karaka2Row.insertCell();
            const karaka2Samyoga = karaka2Row.insertCell();
            const karaka2Drusti = karaka2Row.insertCell();
            const karaka2Pm = karaka2Row.insertCell();

            function copyPlanetToKaraka(planetName){
                if (!planetName) {
                    [karakaAdhipathya,karakaStrength,karakaHidden,karakaHouse,karakaSamyoga,karakaDrusti,karakaPm].forEach(c=>c.textContent='');
                    karakaRashiSpan.textContent = '';
                    karakaPm.className = '';
                    return;
                }
                const srcSelect = document.querySelector(`select[data-planet="${planetName}"]`);
                if (!srcSelect) return;
                const srcRow = srcSelect.parentNode.parentNode;
                const srcRashi = srcSelect.value ? rashis[parseInt(srcSelect.value)-1] : '';
                karakaRashiSpan.textContent = srcRashi;
                karakaAdhipathya.textContent = srcRow.cells[2] ? srcRow.cells[2].textContent : '';
                karakaStrength.textContent = srcRow.cells[3] ? srcRow.cells[3].textContent : '';
                karakaHidden.textContent = srcRow.cells[4] ? srcRow.cells[4].textContent : '';
                karakaHouse.textContent = srcRow.cells[5] ? srcRow.cells[5].textContent : '';
                karakaSamyoga.textContent = srcRow.cells[6] ? srcRow.cells[6].textContent : '';
                karakaDrusti.textContent = srcRow.cells[7] ? srcRow.cells[7].textContent : '';
                karakaPm.textContent = srcRow.cells[8] ? srcRow.cells[8].textContent : '';
                karakaPm.className = srcRow.cells[8] ? srcRow.cells[8].className : '';
            }

            function copyPlanetToKaraka2(planetName){
                if (!planetName) {
                    [karaka2Adhipathya,karaka2Strength,karaka2Hidden,karaka2House,karaka2Samyoga,karaka2Drusti,karaka2Pm].forEach(c=>c.textContent='');
                    karaka2RashiSpan.textContent = '';
                    karaka2Pm.className = '';
                    return;
                }
                const srcSelect = document.querySelector(`select[data-planet="${planetName}"]`);
                if (!srcSelect) return;
                const srcRow = srcSelect.parentNode.parentNode;
                const srcRashi = srcSelect.value ? rashis[parseInt(srcSelect.value)-1] : '';
                karaka2RashiSpan.textContent = srcRashi;
                karaka2Adhipathya.textContent = srcRow.cells[2] ? srcRow.cells[2].textContent : '';
                karaka2Strength.textContent = srcRow.cells[3] ? srcRow.cells[3].textContent : '';
                karaka2Hidden.textContent = srcRow.cells[4] ? srcRow.cells[4].textContent : '';
                karaka2House.textContent = srcRow.cells[5] ? srcRow.cells[5].textContent : '';
                karaka2Samyoga.textContent = srcRow.cells[6] ? srcRow.cells[6].textContent : '';
                karaka2Drusti.textContent = srcRow.cells[7] ? srcRow.cells[7].textContent : '';
                karaka2Pm.textContent = srcRow.cells[8] ? srcRow.cells[8].textContent : '';
                karaka2Pm.className = srcRow.cells[8] ? srcRow.cells[8].className : '';
            }

            karakaSelect.addEventListener('change', (e)=> copyPlanetToKaraka(e.target.value));
            karaka2Select.addEventListener('change', (e)=> copyPlanetToKaraka2(e.target.value));
            window.copyPlanetToKaraka = copyPlanetToKaraka;
            window.copyPlanetToKaraka2 = copyPlanetToKaraka2;
        })();

        loadPlanetStrengthData().then(() => {
            updateCompoundRelationships();
        });

        function applyPositionsFromInput() {
            const input = document.getElementById('positionsInput');
            if (!input) return;
            const raw = input.value.trim();
            if (!raw) return;

            const parts = raw.split(/[.,\s]+/).map(s => s.trim()).filter(Boolean);
            if (parts.length < planets.length) {
                alert('Please provide positions for all planets: Lg, Su, Ch, Ku, Bu, Gu, Sk, Sa, Ra, Ke');
                return;
            }

            const selects = getPlanetSelectsOrdered();
            for (let i = 0; i < planets.length && i < parts.length; i++) {
                const v = parts[i];
                const n = parseInt(v, 10);
                if (!selects[i]) continue;
                selects[i].value = isNaN(n) ? '' : String(n);
                const row = selects[i].parentNode.parentNode;
                if (row && row.cells && row.cells[4]) {
                    row.cells[4].textContent = isNaN(n) ? '' : String(n);
                }
            }

            updateChart();
            updateCompoundRelationships();
            if (typeof updateLordRow === 'function') updateLordRow();
            if (typeof copyPlanetToKaraka === 'function') {
                const karakaSelect = Array.from(document.querySelectorAll('#topTable select')).find(s => s && s.options && s.options.length > 1);
                const karaka2Select = Array.from(document.querySelectorAll('#topTable select')).reverse().find(s => s && s.options && s.options.length > 1);
                if (karakaSelect && karakaSelect.value) copyPlanetToKaraka(karakaSelect.value);
                if (karaka2Select && karaka2Select.value) copyPlanetToKaraka2(karaka2Select.value);
            }
        }

        document.getElementById('applyPositionsBtn').addEventListener('click', applyPositionsFromInput);

        function showContextWindow() {
            const contextWindow = document.getElementById('contextWindow');
            const overlay = document.getElementById('overlay');
            const planetDetails = document.getElementById('planetDetails');
            planetDetails.innerHTML = '';
        
            const selects = getPlanetSelectsOrdered();
            
            planets.forEach((planet, index) => {
                const select = selects[index];
                const row = select.parentNode.parentNode;
                const rashiValue = select.value ? rashis[parseInt(select.value) - 1] : '';
                const adhipathya = row.cells[2].textContent;
                const strength = row.cells[3].textContent;
                const sthaana = row.cells[5].textContent;
                const samyoga = row.cells[6].textContent;
                const drusti = row.cells[7].textContent;
                const compoundRel = row.cells[8].textContent;
        
                if ((rashiValue || adhipathya || sthaana || samyoga || drusti || compoundRel) && planet !== 'Lg') {
                    const planetInfo = document.createElement('div');
                    planetInfo.className = 'planet-info';
                    
                    let infoText = `<h3>${planet}</h3><p>`;
                    
                    if (adhipathya) {
                        infoText += `${adhipathya} Lord ${planet}`;
                    } else {
                        infoText += planet;
                    }
                    
                    if (strength) {
                        infoText += ` (${strength})`;
                    }
                    
                    if (sthaana) {
                        infoText += ` posited in ${sthaana} House`;
                    }
                    
                    if (samyoga) {
                        infoText += `. Samyoga with ${samyoga}`;
                    }
                    
                    if (drusti) {
                        infoText += `. Aspected by ${drusti}`;
                    }

                    if (compoundRel) {
                        infoText += `. Relationship: ${compoundRel}`;
                    }
                    
                    infoText += '.</p>';
                    planetInfo.innerHTML = infoText;
                    planetDetails.appendChild(planetInfo);
                }
            });
        
            contextWindow.style.display = 'flex';
            overlay.style.display = 'block';
        }

        function hideContextWindow() {
            document.getElementById('contextWindow').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function downloadPlanetDetails() {
            const planetDetails = document.getElementById('planetDetails');
            let textContent = 'Planet Details Report\n\n';
            
            const planetInfos = planetDetails.getElementsByClassName('planet-info');
            Array.from(planetInfos).forEach(planetInfo => {
                const text = planetInfo.textContent.trim()
                    .replace(/\n+/g, '\n')
                    .replace(/\s+/g, ' ')
                    .trim();
                textContent += text + '\n\n';
            });

            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'planet_details.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
